<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover,user-scalable=no"/>
<meta name="apple-mobile-web-app-capable" content="yes"/>
<title>Cozy Life 3D ‚Äî Creator</title>
<style>
  *{box-sizing:border-box}html,body{height:100%;margin:0}
  body{background:#0e141b;color:#e7ecf2;font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;overflow:hidden}
  header,footer{position:fixed;left:0;right:0;background:#111826;display:flex;align-items:center;justify-content:space-between;padding:10px 12px;z-index:9}
  header{top:0;box-shadow:0 2px 12px rgba(0,0,0,.35)}
  footer{bottom:0;gap:8px;justify-content:center;flex-wrap:wrap}
  .badge{background:#1a2330;padding:2px 8px;border-radius:999px;font-size:12px}
  #bars{position:fixed;left:10px;right:10px;top:56px;display:grid;grid-template-columns:1fr 1fr;gap:8px;z-index:8}
  .bar{display:flex;gap:8px;align-items:center}.bar label{width:80px;opacity:.85}
  .meter{flex:1;height:10px;background:#16202b;border-radius:999px;overflow:hidden}
  .meter span{display:block;height:100%;background:linear-gradient(90deg,#4fd1ff,#7cffb2)}
  #tabs{position:fixed;left:10px;right:10px;top:124px;display:flex;gap:8px;z-index:8;flex-wrap:wrap}
  #tabs button{padding:10px 12px;border:0;border-radius:12px;background:#17212c;color:#e7ecf2}
  #tabs button.active{outline:2px solid rgba(255,255,255,.15)}
  .panel{position:fixed;left:10px;right:10px;bottom:74px;background:#0f151d;border-radius:14px;padding:10px;display:none;z-index:8}
  .panel.active{display:block}
  .grid{display:grid;grid-template-columns:repeat(4,1fr);gap:8px}
  .list{display:grid;gap:8px}
  .card{display:flex;justify-content:space-between;align-items:center;background:#121a24;border-radius:12px;padding:10px 12px}
  .name{font-weight:700}.meta{opacity:.85;font-size:13px}
  #rooms{position:fixed;right:10px;top:86px;display:flex;gap:6px;z-index:8}
  #rooms button{padding:8px 10px;border:0;border-radius:10px;background:#1a2330;color:#e7ecf2;font-size:12px}
  #toast{position:fixed;left:50%;top:22%;transform:translateX(-50%);background:rgba(0,0,0,.6);padding:10px 14px;border-radius:10px;backdrop-filter:blur(8px);z-index:99}
  #centerCam{position:fixed;left:10px;bottom:140px;z-index:8;border:0;border-radius:10px;background:#1a2330;color:#e7ecf2;padding:8px 10px}
  canvas{position:fixed;inset:0}
  /* simple inputs */
  #p-me label{display:flex;flex-direction:column;gap:6px;font-size:14px}
  #p-me input[type=range], #p-me select{width:100%;padding:8px;border:0;border-radius:10px;background:#17212c;color:#e7ecf2}
</style>
</head>
<body>
<header>
  <div>Cozy Life <span class="badge">3D</span></div>
  <div><span id="clock">7:00 AM</span> ‚Ä¢ <span id="job">Unemployed</span> ‚Ä¢ $<span id="money">120</span></div>
</header>

<!-- needs -->
<div id="bars">
  <div class="bar"><label>Energy</label><div class="meter"><span id="bEnergy"></span></div></div>
  <div class="bar"><label>Hunger</label><div class="meter"><span id="bHunger"></span></div></div>
  <div class="bar"><label>Fun</label><div class="meter"><span id="bFun"></span></div></div>
  <div class="bar"><label>Clean</label><div class="meter"><span id="bClean"></span></div></div>
  <div class="bar"><label>Edu</label><div class="meter"><span id="bEdu"></span></div></div>
  <div class="bar"><label>Rep</label><div class="meter"><span id="bRep"></span></div></div>
</div>

<!-- rooms quick nav -->
<div id="rooms">
  <button data-room="living">Living</button>
  <button data-room="kitchen">Kitchen</button>
  <button data-room="bathroom">Bathroom</button>
  <button data-room="bedroom">Bedroom</button>
</div>
<button id="centerCam">Center Camera</button>

<!-- tabs -->
<div id="tabs">
  <button data-tab="actions" class="active">Actions</button>
  <button data-tab="jobs">Jobs</button>
  <button data-tab="relationships">Relationships</button>
  <button data-tab="me">Me</button>
</div>

<!-- actions -->
<section id="p-actions" class="panel active">
  <div class="grid" id="acts">
    <button data-act="eat">Eat üç≤</button>
    <button data-act="sleep">Sleep üõèÔ∏è</button>
    <button data-act="shower">Shower üöø</button>
    <button data-act="tv">Watch TV üì∫</button>
    <button data-act="study">Study üìö</button>
    <button data-act="work">Work üíº</button>
    <button data-act="clean">Clean üßπ</button>
    <button data-act="save">Save üíæ</button>
  </div>
  <div class="meta">Tip: **Tap the floor** to walk. **Tap sofa/bed/shower/counter** to auto‚Äëwalk and do it.</div>
</section>

<!-- jobs -->
<section id="p-jobs" class="panel">
  <div id="jobsList" class="list"></div>
</section>

<!-- relationships -->
<section id="p-relationships" class="panel">
  <div id="npcList" class="list"></div>
  <div class="card" id="npcActions" style="display:none">
    <div id="npcName">‚Äî</div>
    <div style="display:flex;gap:8px">
      <button data-npc="chat">Chat üí¨</button>
      <button data-npc="compliment">Compliment üåü</button>
      <button data-npc="gift">Gift üéÅ ($25)</button>
      <button data-npc="date">Ask Out ‚ù§Ô∏è ($40)</button>
    </div>
  </div>
</section>

<!-- ME: simple character creator -->
<section id="p-me" class="panel">
  <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px">
    <label>Skin tone
      <select id="skin">
        <option value="#2c1f16" selected>Deep brown</option>
        <option value="#3b2a1d">Warm brown</option>
        <option value="#5a3b2b">Brown</option>
        <option value="#7a543e">Tan</option>
        <option value="#a1765c">Light tan</option>
      </select>
    </label>
    <label>Hair style
      <select id="hairStyle">
        <option value="curls" selected>Curls</option>
        <option value="bun">Bun</option>
        <option value="braids">Braids</option>
        <option value="short">Short</option>
      </select>
    </label>
    <label>Hair color
      <select id="hairColor">
        <option value="#0c0b0c" selected>Black</option>
        <option value="#2b1d12">Dark brown</option>
        <option value="#4a2c1a">Brown</option>
        <option value="#2b2b2b">Gray</option>
      </select>
    </label>

    <div style="grid-column:1 / span 2;display:grid;grid-template-columns:1fr 1fr;gap:10px;background:#121a24;border-radius:10px;padding:10px">
      <div style="font-weight:700;opacity:.9">Simple Character Creator</div><div></div>
      <label>Height <input id="ccHeight" type="range" min="0.9" max="1.2" step="0.01" value="1.00"></label>
      <label>Head size <input id="ccHead" type="range" min="0.8" max="1.3" step="0.01" value="1.00"></label>
      <label>Eye size <input id="ccEyeSize" type="range" min="0.6" max="1.4" step="0.02" value="1.00"></label>
      <label>Eye gap <input id="ccEyeGap" type="range" min="-8" max="8" step="1" value="0"></label>
      <label>Nose length <input id="ccNose" type="range" min="0.8" max="1.4" step="0.02" value="1.00"></label>
      <label>Mouth width <input id="ccMouth" type="range" min="0.6" max="1.6" step="0.02" value="1.00"></label>
      <div style="grid-column:1 / span 2;display:flex;gap:8px">
        <button id="ccRandom">Randomize</button>
        <button id="ccSave">Save Look</button>
      </div>
    </div>

    <div style="grid-column:1 / span 2;display:flex;gap:8px;align-items:center">
      <span class="badge">Outfit</span><button id="outfit">Change</button>
      <span class="badge">Time</span><input id="time" type="range" min="0.5" max="6" step="0.5" value="2" style="width:160px"><span id="tLbl" class="badge">2 min/sec</span>
    </div>
  </div>
</section>

<div id="toast" hidden></div>
<canvas id="webgl"></canvas>
<footer>
  <button id="load">Load</button>
  <button id="reset">Reset</button>
</footer>

<!-- Three.js -->
<script src="https://unpkg.com/three@0.160.0/build/three.min.js"></script>

<script>
(()=>{ // ===== GAME =====
/* ---------- helpers ---------- */
const $=id=>document.getElementById(id), $$=s=>Array.from(document.querySelectorAll(s));
const clamp=(n,a,b)=>Math.max(a,Math.min(b,n));
const hour=t=>Math.floor((t/60)%24);
const timeFmt=m=>{const h=hour(m),mi=Math.floor(m%60),ap=h>=12?'PM':'AM',hh=((h+11)%12+1);return `${hh}:${String(mi).padStart(2,'0')} ${ap}`;}
const OUTFITS=[{top:0xa86dff,bottom:0x22252d,shoes:0xe7ecf2,name:'Casual'},{top:0x2ec27e,bottom:0x1f2a22,shoes:0xe8ecf1,name:'Work'},{top:0x4fd1ff,bottom:0x14202a,shoes:0xc8f7ff,name:'Gym'},{top:0xff6b9a,bottom:0x2a2e39,shoes:0xf5d36b,name:'Night Out'}];
function toast(msg,ms=1200){const t=$('toast'); t.textContent=msg; t.hidden=false; clearTimeout(toast._h); toast._h=setTimeout(()=>t.hidden=true,ms);}

/* ---------- state ---------- */
const S={room:'living',t:7*60,speed:2,energy:70,hunger:30,fun:40,clean:60,edu:10,rep:10,money:120,job:null,npcs:[],sel:null,lastNpcDay:-1};
const A={skin:'#2c1f16',hair:'#0c0b0c',hairStyle:'curls',body:'slim',outfit:0};
const CC={height:1.00,head:1.00,eyeSize:1.00,eyeGap:0,nose:1.00,mouth:1.00}; // creator sliders
const JOBS={barista:{name:'Barista',open:[6,14],pay:16,req:0},stripper:{name:'Performer (Club)',open:[19,2],pay:28,req:0,audition:true},lawyer:{name:'Junior Lawyer',open:[9,19],pay:55,req:70},doctor:{name:'Resident Doctor',open:[7,19],pay:60,req:85}};
const rand=n=>Math.floor(Math.random()*n);

/* ---------- UI ---------- */
$('jobsList').innerHTML = Object.keys(JOBS).map(k=>{const j=JOBS[k];return `<div class="card" data-job="${k}"><div><div class="name">${j.name}</div><div class="meta">$${j.pay}/hr ‚Ä¢ ${fmtHours(j.open)} ‚Ä¢ ${j.req?('Edu '+j.req+'+'): 'No req'}</div></div><button>${k==='stripper'?'Audition':'Apply'}</button></div>`}).join('');
$('p-jobs').addEventListener('click',e=>{
  const c=e.target.closest('.card'); if(!c) return;
  const k=c.dataset.job, j=JOBS[k];
  if(k==='stripper'){ const score=(S.fun+S.clean+S.rep)/3+Math.random()*20; if(score<45) return toast('Audition didn‚Äôt stick'); S.job=k; }
  else { if(S.edu<j.req) return toast('Not qualified yet'); S.job=k; }
  $('job').textContent=JOBS[S.job].name; toast('Hired!');
});
$('tabs').addEventListener('click',e=>{const b=e.target.closest('button'); if(!b)return; $$('#tabs button').forEach(x=>x.classList.remove('active')); b.classList.add('active'); $$('.panel').forEach(p=>p.classList.remove('active')); $('p-'+b.dataset.tab).classList.add('active');});
$('rooms').addEventListener('click',e=>{const r=e.target.getAttribute('data-room'); if(!r)return; switchRoom(r,true);});
$('acts').addEventListener('click',e=>{const k=e.target.getAttribute('data-act'); if(!k) return; ({eat, sleep, shower, tv, study, work, clean, save})[k](); setBars();});
$('outfit').addEventListener('click',()=>{A.outfit=(A.outfit+1)%OUTFITS.length; applyOutfit(); toast('Outfit: '+OUTFITS[A.outfit].name);});
$('skin').addEventListener('change',e=>{A.skin=e.target.value; drawFace();});
$('hairStyle').addEventListener('change',e=>{A.hairStyle=e.target.value; drawFace();});
$('hairColor').addEventListener('change',e=>{A.hair=e.target.value; drawFace();});
const tSlider=$('time'), tLbl=$('tLbl'); tSlider.value=S.speed; tLbl.textContent=S.speed+' min/sec';
tSlider.addEventListener('input',()=>{S.speed=parseFloat(tSlider.value); tLbl.textContent=S.speed+' min/sec';});
$('load').addEventListener('click',load); $('reset').addEventListener('click',()=>{localStorage.removeItem('cozy3d_creator');location.reload();});
$('centerCam').addEventListener('click',resetView);

/* creator inputs */
['ccHeight','ccHead','ccEyeSize','ccEyeGap','ccNose','ccMouth'].forEach(id=>{
  const el=$(id); el.addEventListener('input', ()=>{
    CC.height = parseFloat($('ccHeight').value);
    CC.head   = parseFloat($('ccHead').value);
    CC.eyeSize= parseFloat($('ccEyeSize').value);
    CC.eyeGap = parseFloat($('ccEyeGap').value);
    CC.nose   = parseFloat($('ccNose').value);
    CC.mouth  = parseFloat($('ccMouth').value);
    applyCreator();
  });
});
$('ccRandom').addEventListener('click', ()=>{
  const r=(a,b)=> (Math.random()*(b-a)+a);
  CC.height = +(r(0.92,1.18)).toFixed(2);
  CC.head   = +(r(0.85,1.25)).toFixed(2);
  CC.eyeSize= +(r(0.70,1.30)).toFixed(2);
  CC.eyeGap = Math.round(r(-6,6));
  CC.nose   = +(r(0.90,1.30)).toFixed(2);
  CC.mouth  = +(r(0.80,1.40)).toFixed(2);
  ccHeight.value=CC.height; ccHead.value=CC.head; ccEyeSize.value=CC.eyeSize; ccEyeGap.value=CC.eyeGap; ccNose.value=CC.nose; ccMouth.value=CC.mouth;
  applyCreator();
});
$('ccSave').addEventListener('click', ()=>{
  const saved = JSON.parse(localStorage.getItem('cozy3d_creator')||'{}');
  localStorage.setItem('cozy3d_creator', JSON.stringify({ ...(saved||{}), S, A, CC }));
  toast('Look saved');
});

/* ---------- 3D ---------- */
const R=new THREE.WebGLRenderer({canvas:$('webgl'),antialias:true}); R.setPixelRatio(Math.min(2,devicePixelRatio||1));
const scene=new THREE.Scene(); scene.background=new THREE.Color(0x0a1016);
const camera=new THREE.PerspectiveCamera(55,1,0.1,100); camera.position.set(0,6,10);
const hemi=new THREE.HemisphereLight(0xffffff,0x223344,1.35); scene.add(hemi);
const sun=new THREE.DirectionalLight(0xffffff,0.9); sun.position.set(2,8,5); sun.castShadow=true; scene.add(sun);
function onResize(){const w=innerWidth,h=innerHeight; R.setSize(w,h); camera.aspect=w/h; camera.updateProjectionMatrix();}
addEventListener('resize',onResize,{passive:true}); onResize();

/* Floor per room */
const floorGeo=new THREE.PlaneGeometry(20,14);
const floors={
  living : new THREE.Mesh(floorGeo,new THREE.MeshStandardMaterial({color:0x202830,roughness:.9})),
  kitchen: new THREE.Mesh(floorGeo,new THREE.MeshStandardMaterial({color:0x303820,roughness:.85})),
  bathroom:new THREE.Mesh(floorGeo,new THREE.MeshStandardMaterial({color:0x283036,roughness:.85})),
  bedroom : new THREE.Mesh(floorGeo,new THREE.MeshStandardMaterial({color:0x2e2530,roughness:.85}))
};
Object.values(floors).forEach(m=>{m.rotation.x=-Math.PI/2;m.receiveShadow=true;});

/* Furniture */
const room = new THREE.Group(); scene.add(room);
function box(w,h,d,c){const m=new THREE.Mesh(new THREE.BoxGeometry(w,h,d),new THREE.MeshStandardMaterial({color:c,roughness:.8})); m.castShadow=true; m.receiveShadow=true; return m;}
function furnFor(r){
  const g=new THREE.Group();
  if(r==='living'){const sofa=box(3,1,1,0x8a685a); sofa.position.set(0,0.5,-2); sofa.userData={type:'tv'}; g.add(sofa); const tv=box(2,1.2,0.5,0x1d2129); tv.position.set(-6,0.6,2); tv.userData={type:'tv'}; g.add(tv);}
  if(r==='kitchen'){const counter=box(8,1,1,0x555555); counter.position.set(0,0.5,-3); counter.userData={type:'eat'}; g.add(counter);}
  if(r==='bathroom'){const sh=box(1.2,2,1.2,0x2a3a44); sh.position.set(5,1,-1); sh.userData={type:'shower'}; g.add(sh);}
  if(r==='bedroom'){const bed=box(4,1,2,0x7a89c2); bed.position.set(0,0.5,-2); bed.userData={type:'sleep'}; g.add(bed);}
  return g;
}

/* Doors */
const doorGroup=new THREE.Group(); scene.add(doorGroup);
const DOORS={living:[{x:-9,z:0,to:'kitchen'},{x:9,z:0,to:'bathroom'}],
             kitchen:[{x:9,z:0,to:'living'},{x:-9,z:0,to:'bedroom'}],
             bathroom:[{x:-9,z:0,to:'living'}],
             bedroom:[{x:9,z:0,to:'kitchen'}]};
function drawDoors(r){ doorGroup.clear(); (DOORS[r]||[]).forEach(d=>{const m=box(0.8,2.2,0.2,0x1a2330); m.position.set(d.x,1.1,d.z); m.userData.to=d.to; doorGroup.add(m);}); }

/* Player (simple rig + face plate) */
const player=new THREE.Group(); scene.add(player);
const faceCan=document.createElement('canvas'); faceCan.width=256; faceCan.height=256; const faceTex=new THREE.CanvasTexture(faceCan);
const torso=new THREE.Mesh(new THREE.CapsuleGeometry(0.45,1.2,8,16), new THREE.MeshStandardMaterial({color:OUTFITS[A.outfit].top})); torso.position.y=1.6; torso.castShadow=true; player.add(torso);
const legL=new THREE.Mesh(new THREE.CapsuleGeometry(0.2,0.6,6,12), new THREE.MeshStandardMaterial({color:OUTFITS[A.outfit].bottom})); legL.position.set(-0.2,0.6,0); player.add(legL);
const legR=legL.clone(); legR.position.x=0.2; player.add(legR);
const head=new THREE.Mesh(new THREE.SphereGeometry(0.35,24,24), new THREE.MeshStandardMaterial({map:faceTex})); head.position.y=2.4; player.add(head);
const hair=new THREE.Mesh(new THREE.SphereGeometry(0.37,24,24,0,Math.PI*2,0,Math.PI/1.8), new THREE.MeshStandardMaterial({color:A.hair})); hair.position.copy(head.position); hair.position.y+=0.02; player.add(hair);
// flat face plate so the face is always readable
const facePlate = new THREE.Mesh(new THREE.PlaneGeometry(0.58,0.58), new THREE.MeshBasicMaterial({map:faceTex,transparent:true}));
facePlate.position.set(0,2.4,0.34); player.add(facePlate);

function drawFace(){
  const c = faceCan.getContext('2d');
  c.clearRect(0,0,256,256);
  // circular mask
  c.save(); c.beginPath(); c.arc(128,128,112,0,Math.PI*2); c.clip();
  // skin
  c.fillStyle = A.skin; c.fillRect(0,0,256,256);
  // hair front/bangs
  c.fillStyle = A.hair;
  if(A.hairStyle==='bun'){ c.beginPath(); c.arc(128,44,26,0,Math.PI*2); c.fill(); c.fillRect(64,58,128,22); }
  else if(A.hairStyle==='curls'){ for(let i=0;i<20;i++){ const x=40+i*9, y=58+Math.sin(i)*2; c.beginPath(); c.arc(x,y,10,0,Math.PI*2); c.fill(); } }
  else if(A.hairStyle==='braids'){ for(let i=0;i<8;i++){ c.fillRect(80+i*8,58,4,28); } }
  else { c.fillRect(70,58,116,20); }
  // eyes with sliders
  const es = 10*CC.eyeSize, gap = 10 + CC.eyeGap;
  c.fillStyle="#fff";
  c.fillRect(128-gap-(es+6)/2,108, es+6, es);
  c.fillRect(128+gap-(es+6)/2,108, es+6, es);
  c.fillStyle="#111";
  c.fillRect(128-gap-es/2,110, es*0.6, es*0.6);
  c.fillRect(128+gap-es/2,110, es*0.6, es*0.6);
  // nose
  c.fillStyle="#00000033";
  const noseL = 12*CC.nose;
  c.beginPath(); c.moveTo(128,128); c.lineTo(124,128+noseL); c.lineTo(132,128+noseL); c.closePath(); c.fill();
  // mouth
  const mw = 28*CC.mouth;
  c.fillStyle="#b66"; c.fillRect(128-mw/2,160, mw, 6);
  c.restore();
  faceTex.needsUpdate=true;
}
function applyOutfit(){ torso.material.color.setHex(OUTFITS[A.outfit].top); legL.material.color.setHex(OUTFITS[A.outfit].bottom); legR.material.color.setHex(OUTFITS[A.outfit].bottom); }
function applyCreator(){ player.scale.set(1, CC.height, 1); head.scale.set(CC.head,CC.head,CC.head); drawFace(); }
function applyBody(){ applyCreator(); } // keep simple
drawFace(); applyOutfit(); applyCreator();

/* NPCs */
const npcs=new THREE.Group(); scene.add(npcs);
function spawnNpc(){
  if(S.npcs.length>=3) return;
  const g=new THREE.Group();
  const b=new THREE.Mesh(new THREE.CapsuleGeometry(0.4,1.0,8,16),new THREE.MeshStandardMaterial({color:0x4fd1ff})); b.position.y=1.4; g.add(b);
  const h=new THREE.Mesh(new THREE.SphereGeometry(0.32,20,20),new THREE.MeshStandardMaterial({color:0xc99b75})); h.position.y=2.1; g.add(h);
  g.position.set((Math.random()<.5?-1:1)*5,0,(Math.random()<.5?-1:1)*2); g.userData={vx:(Math.random()<.5?-1:1)*0.6,name:randName(),rel:10+rand(15),status:'acquaintance'};
  npcs.add(g); S.npcs.push({id:cryptoRandom(),name:g.userData.name,rel:g.userData.rel,status:'acquaintance',obj:g});
}
function moveNpcs(dt){ npcs.children.forEach(n=>{ n.position.x+=n.userData.vx*dt; if(n.position.x<-8||n.position.x>8) n.userData.vx*=-1; }); }
function renderNpcList(){
  $('npcList').innerHTML=S.npcs.map(n=>`<div class="card" data-id="${n.id}"><div><div class="name">${n.name}</div><div class="meta">${n.status}</div></div><div class="meta">Rel ${n.rel}</div></div>`).join('');
  $$('#npcList .card').forEach(el=>el.addEventListener('click',()=>{ const n=S.npcs.find(x=>x.id===el.dataset.id); S.sel=n; $('npcActions').style.display='flex'; $('npcName').textContent=`${n.name} ‚Ä¢ Rel ${n.rel}`; }));
}

/* Room switching */
function resetView(){ player.position.set(0,0,0); camera.position.set(0,5.8,9.5); camera.lookAt(0,1.2,0); target=null; }
function switchRoom(name,tele){ if(!floors[name]) return; Object.values(floors).forEach(m=>scene.remove(m)); scene.add(floors[name]); S.room=name; room.clear(); room.add(furnFor(name)); drawDoors(name); if(tele) resetView(); }

/* Tap to move / interact */
const ray=new THREE.Raycaster(); let target=null;
$('webgl').addEventListener('pointerdown',e=>{
  const r=$('webgl').getBoundingClientRect(); const x=(e.clientX-r.left)/r.width*2-1, y=-((e.clientY-r.top)/r.height*2-1);
  const m=new THREE.Vector2(x,y); ray.setFromCamera(m,camera);
  const d=ray.intersectObjects(doorGroup.children,true)[0]; if(d && d.object.userData.to){ switchRoom(d.object.userData.to,true); return; }
  const f=ray.intersectObjects(room.children,true)[0];
  if(f && f.object.userData.type){ target=f.point.clone(); target.userData=f.object.userData.type; return; }
  const floorHit=ray.intersectObject(floors[S.room],true)[0]; if(floorHit){ target=floorHit.point.clone(); target.userData=null; }
},{passive:true});

/* Loop */
let last=performance.now();
function tick(now){
  const dt=Math.min(50,now-last)/1000; last=now;
  // needs/time
  S.t += S.speed*dt; const s=S.speed/2; S.hunger=clamp(S.hunger+0.25*s*dt,0,100); S.energy=clamp(S.energy-0.18*s*dt,0,100); S.clean=clamp(S.clean-0.10*s*dt,0,100); S.fun=clamp(S.fun-0.08*s*dt,0,100);
  const day=Math.floor(S.t/(24*60)); if(day!==S.lastNpcDay){S.lastNpcDay=day; spawnNpc(); renderNpcList();}
  moveNpcs(60*dt);
  // move player
  if(target){
    const p=new THREE.Vector3(player.position.x,0,player.position.z), to=target.clone().setY(0), dir=to.clone().sub(p), L=dir.length();
    if(L>0.05){ dir.normalize(); player.position.add(dir.multiplyScalar(2.2*dt)); player.lookAt(to.x,player.position.y,to.z); }
    else { if(target.userData){ doInteract(target.userData); } target=null; }
  }
  // keep face readable
  facePlate.lookAt(camera.position);
  followCam();
  setBars();
  R.render(scene,camera);
  requestAnimationFrame(tick);
}
function followCam(){ const target=new THREE.Vector3(player.position.x,1.2,player.position.z); const pos=new THREE.Vector3(player.position.x,5.8,player.position.z+7.5); camera.position.lerp(pos,0.08); camera.lookAt(target); }

/* Interactions */
function doInteract(type){ if(type==='sleep'){sleep();toast('You slept');} if(type==='shower'){shower();toast('Shower done');} if(type==='eat'){eat();toast('Ate a meal');} if(type==='tv'){tv();toast('Watched TV');} }
function eat(){ if(S.money<8) return toast('Need $8'); S.money-=8; S.hunger=clamp(S.hunger-35,0,100); S.energy=clamp(S.energy+5,0,100); timePass(20); }
function sleep(){ let m=0; while(S.energy<95&&m<8*60){ S.energy=clamp(S.energy+1.2,0,100); S.hunger=clamp(S.hunger+0.4,0,100); m+=10;} timePass(m); }
function shower(){ S.clean=clamp(S.clean+35,0,100); S.energy=clamp(S.energy+2,0,100); timePass(15); }
function tv(){ S.fun=clamp(S.fun+28,0,100); S.energy=clamp(S.energy-6,0,100); timePass(40); }
function study(){ if(S.energy<20) return toast('Too tired'); S.edu=clamp(S.edu+6+rand(4),0,100); S.energy=clamp(S.energy-10,0,100); S.fun=clamp(S.fun-4,0,100); timePass(50); }
function work(){ if(!S.job) return toast('No job yet'); const j=JOBS[S.job], h=hour(S.t), [o,c]=j.open, open = o<c ? (h>=o&&h<c) : (h>=o||h<c);
  if(!open) return toast('Job closed now');
  const hrs=2+rand(2), pay=j.pay*hrs + (S.job==='stripper'?rand(80):0), perf=(S.energy>40?1:0.7)*(S.clean>40?1:0.8);
  S.money+=Math.floor(pay*perf); S.energy=clamp(S.energy-12*hrs/2,0,100); S.hunger=clamp(S.hunger+10*hrs/2,0,100); S.fun=clamp(S.fun+(S.job==='stripper'?4:-4),0,100); S.clean=clamp(S.clean-6*hrs/2,0,100);
  timePass(hrs*60); toast(`Worked ${hrs}h, earned $${Math.floor(pay*perf)}`);}
function clean(){ S.clean=clamp(S.clean+28,0,100); S.energy=clamp(S.energy-5,0,100); timePass(30); }
function save(){ localStorage.setItem('cozy3d_creator',JSON.stringify({S,A,CC})); toast('Saved'); }
function load(){ const raw=localStorage.getItem('cozy3d_creator'); if(!raw) return toast('No save'); try{ const d=JSON.parse(raw); Object.assign(S,d.S||{}); Object.assign(A,d.A||{}); Object.assign(CC,d.CC||{}); // restore creator
  // reflect sliders
  ccHeight.value=CC.height; ccHead.value=CC.head; ccEyeSize.value=CC.eyeSize; ccEyeGap.value=CC.eyeGap; ccNose.value=CC.nose; ccMouth.value=CC.mouth;
  applyOutfit(); applyCreator(); drawFace(); setBars(); $('job').textContent=S.job?JOBS[S.job].name:'Unemployed'; switchRoom(S.room,true); toast('Loaded'); }catch{ toast('Load failed'); }}
function setBars(){ $('bEnergy').style.width=S.energy+'%'; $('bHunger').style.width=(100-S.hunger)+'%'; $('bFun').style.width=S.fun+'%'; $('bClean').style.width=S.clean+'%'; $('bEdu').style.width=S.edu+'%'; $('bRep').style.width=S.rep+'%'; $('money').textContent=Math.floor(S.money); $('clock').textContent=timeFmt(S.t); $('job').textContent=S.job?JOBS[S.job].name:'Unemployed'; }
function bump(k,v){ S[k]=clamp(S[k]+v,0,100); }
function timePass(m){ S.t+=m; }
function fmtHours([o,c]){ const f=h=>h===0?'12a':(h<12?`${h}a`:(h===12?'12p':`${h-12}p`)); return `${f(o)}‚Äì${f(c)}` }
function randName(){const a=['Alex','Jordan','Taylor','Riley','Casey','Avery','Kai','Skye','Nina','Malik','Jada','Imani','Noah']; return a[rand(a.length)]+' '+(Math.random()<0.5?'B.':'C.');}
function cryptoRandom(){return Math.random().toString(36).slice(2); }

/* Boot */
function boot(){ switchRoom('living',true); spawnNpc(); renderNpcList(); setBars(); requestAnimationFrame(tick); }
boot();
})();</script>
</body>
</html>
