<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no, viewport-fit=cover">
<title>Cozy Sim Plus ‚Äî Character & Outfits</title>
<meta name="theme-color" content="#0f1318">
<style>
*{box-sizing:border-box}html,body{height:100%;margin:0}
body{background:#0f1318;color:#e7ecf2;font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif}
header,footer{position:fixed;left:0;right:0;background:#121821;display:flex;justify-content:space-between;align-items:center;padding:10px 14px;z-index:3}
header{top:0;box-shadow:0 2px 12px rgba(0,0,0,.35)}
footer{bottom:0;gap:8px;justify-content:center}
#title{font-weight:700}
.pill{font-size:12px;margin-left:6px;background:#1b2430;border-radius:999px;padding:2px 8px;opacity:.85}
.left,.right{display:flex;align-items:center;gap:14px}
#jobLabel{opacity:.9}
main{position:fixed;left:0;right:0;top:54px;bottom:64px;display:flex;flex-direction:column;gap:10px;padding:10px}
#room{flex:1;border-radius:14px;background:#0b0f14;box-shadow:inset 0 0 0 1px rgba(255,255,255,.06), 0 10px 30px rgba(0,0,0,.4)}
#hud{display:grid;grid-template-columns:1fr 1fr;gap:8px}
.bar{display:flex;align-items:center;gap:8px}
.bar label{width:72px;opacity:.85}
.meter{flex:1;height:10px;background:#18202a;border-radius:999px;overflow:hidden}
.meter span{display:block;height:100%;background:linear-gradient(90deg,#4fd1ff,#7cffb2)}
#tabs{display:flex;gap:8px}
#tabs button{padding:10px 12px;border:0;border-radius:10px;background:#17202a;color:#e7ecf2}
#tabs button.active{outline:2px solid rgba(255,255,255,.15)}
.panel{display:none}
.panel.active{display:block}
#actions.grid{display:grid;grid-template-columns:repeat(4,1fr);gap:8px}
#actions button{padding:12px;border:0;border-radius:12px;background:#17202a;color:#e7ecf2;box-shadow:0 2px 0 rgba(255,255,255,.04) inset, 0 6px 16px rgba(0,0,0,.35)}
#actions button:active{transform:translateY(1px)}
#shop{background:#0e141b;border-radius:10px;padding:10px}
.shop-row{display:grid;grid-template-columns:repeat(4,1fr);gap:8px;margin-bottom:8px}
.shop-item{padding:10px;border:0;border-radius:10px;background:#17202a;color:#e7ecf2}
.hint{opacity:.7;font-size:12px;margin-top:6px}
.jobs{display:grid;grid-template-columns:1fr;gap:8px}
.job{display:flex;justify-content:space-between;align-items:center;background:#0e141b;border-radius:10px;padding:10px}
.job .name{font-weight:700}
.job .info{opacity:.85;font-size:13px}
.job .apply{padding:8px 12px;border:0;border-radius:10px;background:#1a2532;color:#e7ecf2}
.npc-list{display:grid;grid-template-columns:1fr;gap:8px}
.npc{display:flex;justify-content:space-between;align-items:center;background:#0e141b;border-radius:10px;padding:10px}
.npc .meta{opacity:.85;font-size:13px}
.npc .rel{font-weight:700}
.npc-actions{margin-top:8px;background:#0e141b;border-radius:10px;padding:10px}
.npc-actions .buttons{display:grid;grid-template-columns:repeat(4,1fr);gap:8px}
.npc-actions button{padding:10px;border:0;border-radius:10px;background:#17202a;color:#e7ecf2}
#toast{position:fixed;left:50%;top:20%;transform:translateX(-50%);background:rgba(0,0,0,.65);padding:10px 14px;border-radius:10px;backdrop-filter:blur(8px);z-index:9}

/* Character modal */
.modal{position:fixed;inset:0;background:rgba(0,0,0,.5);display:none;align-items:center;justify-content:center;z-index:10}
.modal .card{background:#0f151c;border-radius:12px;max-width:520px;width:92%;padding:14px;box-shadow:0 10px 30px rgba(0,0,0,.45)}
.modal h2{margin:0 0 8px 0;font-size:18px}
.form{display:grid;grid-template-columns:1fr 1fr;gap:10px}
.row{display:flex;gap:6px;flex-wrap:wrap}
.swatch{width:28px;height:28px;border-radius:999px;border:1px solid rgba(255,255,255,.15)}
.select{width:100%;padding:10px;border-radius:8px;border:0;background:#17202a;color:#e7ecf2}
.modal .actions{display:flex;justify-content:flex-end;gap:8px;margin-top:10px}
.modal button{padding:10px 12px;border:0;border-radius:10px;background:#17202a;color:#e7ecf2}
.preview{height:140px;border-radius:10px;background:#0b0f14;display:flex;align-items:center;justify-content:center}
.slider{width:100%}
.badge{display:inline-block;background:#1b2430;padding:2px 8px;border-radius:999px;font-size:12px;margin-left:6px;opacity:.9}
</style>
</head>
<body>
<header>
  <div class="left">
    <div id="title">Cozy Sim <span class="pill">Plus</span></div>
    <div id="clock">7:00 AM</div>
  </div>
  <div class="right">
    <div id="jobLabel">Unemployed</div>
    <div id="money">$0</div>
  </div>
</header>

<main>
  <canvas id="room" aria-label="Room view"></canvas>

  <section id="hud">
    <div class="bar"><label>Energy</label><div class="meter"><span id="energy"></span></div></div>
    <div class="bar"><label>Hunger</label><div class="meter"><span id="hunger"></span></div></div>
    <div class="bar"><label>Fun</label><div class="meter"><span id="fun"></span></div></div>
    <div class="bar"><label>Clean</label><div class="meter"><span id="clean"></span></div></div>
    <div class="bar"><label>Edu</label><div class="meter"><span id="edu"></span></div></div>
    <div class="bar"><label>Rep</label><div class="meter"><span id="rep"></span></div></div>
  </section>

  <section id="tabs">
    <button data-tab="actions" class="active">Actions</button>
    <button data-tab="jobs">Jobs</button>
    <button data-tab="relationships">Relationships</button>
    <button data-tab="me">Me</button>
  </section>

  <section id="panel-actions" class="panel active">
    <div id="actions" class="grid">
      <button data-act="eat">Eat üç≤</button>
      <button data-act="sleep">Sleep üò¥</button>
      <button data-act="shower">Shower üöø</button>
      <button data-act="play">Play üéÆ</button>
      <button data-act="clean">Clean üßπ</button>
      <button data-act="study">Study üìö</button>
      <button data-act="work">Work üíº</button>
      <button data-act="decorate">Decor ü™ë</button>
    </div>
    <div id="shop" hidden>
      <div class="shop-row">
        <button class="shop-item" data-item="sofa">Sofa $80</button>
        <button class="shop-item" data-item="plant">Plant $20</button>
        <button class="shop-item" data-item="tv">TV $120</button>
        <button class="shop-item" data-item="bed">Bed $150</button>
      </div>
      <div class="hint">Drag furniture in Decor mode. Tap Decor to close.</div>
    </div>
  </section>

  <section id="panel-jobs" class="panel">
    <div class="jobs">
      <div class="job" data-job="barista">
        <div class="name">Barista</div>
        <div class="info">Pay $16/hr ‚Ä¢ 6a‚Äì2p ‚Ä¢ No req</div>
        <button class="apply">Apply</button>
      </div>
      <div class="job" data-job="stripper">
        <div class="name">Performer (Club)</div>
        <div class="info">Pay $28/hr + tips ‚Ä¢ 7p‚Äì2a ‚Ä¢ Audition</div>
        <button class="apply">Audition</button>
      </div>
      <div class="job" data-job="lawyer">
        <div class="name">Junior Lawyer</div>
        <div class="info">Pay $55/hr ‚Ä¢ 9a‚Äì7p ‚Ä¢ Edu 70+</div>
        <button class="apply">Apply</button>
      </div>
      <div class="job" data-job="doctor">
        <div class="name">Resident Doctor</div>
        <div class="info">Pay $60/hr ‚Ä¢ 7a‚Äì7p ‚Ä¢ Edu 85+</div>
        <button class="apply">Apply</button>
      </div>
    </div>
    <div class="hint">Once hired, tap Work on the Actions tab during open hours.</div>
  </section>

  <section id="panel-relationships" class="panel">
    <div id="npcList" class="npc-list"></div>
    <div id="npcActions" class="npc-actions" hidden>
      <div id="npcName">‚Äî</div>
      <div class="buttons">
        <button data-npcact="chat">Chat üí¨</button>
        <button data-npcact="compliment">Compliment üåü</button>
        <button data-npcact="gift">Gift üéÅ ($25)</button>
        <button data-npcact="date">Ask Out ‚ù§Ô∏è ($40)</button>
      </div>
    </div>
    <div class="hint">New NPCs appear each day. Build relationships to become partners.</div>
  </section>

  <section id="panel-me" class="panel">
    <div class="hint">Customize your character, outfits, and time speed.</div>
    <div class="row" style="margin:8px 0;gap:8px">
      <button id="openCreator">Open Creator</button>
      <button id="cycleOutfit">Change Outfit</button>
      <span class="badge">Time speed</span>
      <input id="timeSlider" class="slider" type="range" min="0.5" max="8" step="0.5">
      <span id="timeLabel" class="badge">2 min/sec</span>
    </div>
  </section>
</main>

<div id="toast" hidden></div>

<!-- Character Creator Modal -->
<div id="creator" class="modal" role="dialog" aria-modal="true">
  <div class="card">
    <h2>Character Creator</h2>
    <div class="preview"><canvas id="avatar" width="240" height="120"></canvas></div>
    <div class="form" style="margin-top:10px">
      <div>
        <div class="badge">Skin tone</div>
        <div class="row" id="skinRow"></div>
      </div>
      <div>
        <div class="badge">Hair style</div>
        <select id="hairStyle" class="select">
          <option value="bun">Bun</option>
          <option value="curls">Curls</option>
          <option value="braids">Braids</option>
          <option value="short">Short</option>
        </select>
        <div class="badge" style="margin-top:8px;display:block">Hair color</div>
        <div class="row" id="hairRow"></div>
      </div>
      <div>
        <div class="badge">Top</div>
        <div class="row" id="topRow"></div>
      </div>
      <div>
        <div class="badge">Bottoms/Shoes</div>
        <div class="row" id="bottomRow"></div>
      </div>
    </div>
    <div class="actions">
      <button id="closeCreator">Close</button>
      <button id="saveCreator">Save</button>
    </div>
  </div>
</div>

<footer>
  <button id="save">Save</button>
  <button id="load">Load</button>
  <button id="reset">Reset</button>
  <button id="mute">üîä</button>
</footer>

<script>
(()=>{
// ===== Canvas + Layout =====
const canvas = document.getElementById('room');
const ctx = canvas.getContext('2d',{alpha:false});
let W=0,H=0,DPR=Math.max(1,Math.min(2,window.devicePixelRatio||1));
function resize(){ W=window.innerWidth-20; H=Math.max(260,window.innerHeight-54-64-260); canvas.width=Math.floor(W*DPR); canvas.height=Math.floor(H*DPR); canvas.style.width=W+'px'; canvas.style.height=H+'px'; ctx.setTransform(DPR,0,0,DPR,0,0);}
window.addEventListener('resize',resize,{passive:true}); resize();

// ===== UI Els =====
const energyEl=document.getElementById('energy'), hungerEl=document.getElementById('hunger'),
funEl=document.getElementById('fun'), cleanEl=document.getElementById('clean'),
eduEl=document.getElementById('edu'), repEl=document.getElementById('rep'),
moneyEl=document.getElementById('money'), jobLabel=document.getElementById('jobLabel'),
clockEl=document.getElementById('clock'), toast=document.getElementById('toast');

const tabs=document.getElementById('tabs');
const panels={actions:document.getElementById('panel-actions'),jobs:document.getElementById('panel-jobs'),
relationships:document.getElementById('panel-relationships'),me:document.getElementById('panel-me')};
tabs.addEventListener('click',e=>{
  const btn=e.target.closest('button'); if(!btn) return;
  document.querySelectorAll('#tabs button').forEach(b=>b.classList.remove('active'));
  btn.classList.add('active');
  Object.values(panels).forEach(p=>p.classList.remove('active'));
  (panels[btn.dataset.tab]||panels.actions).classList.add('active');
});

// ===== State =====
const state={
  // time: slower default: 2 minutes per real second (was 6)
  t:7*60, speedMinPerSec:2,
  energy:70,hunger:30,fun:40,clean:60,edu:10,rep:10,money:120,sound:true,
  job:null,
  grid:{cols:12,rows:8},
  items:[
    {id:'bed',x:2,y:2,w:2,h:3,color:'#46506a',name:'Bed'},
    {id:'sofa',x:6,y:3,w:3,h:2,color:'#6a5046',name:'Sofa'},
    {id:'tv',x:4,y:6,w:2,h:1,color:'#2d2f38',name:'TV'},
    {id:'plant',x:9,y:2,w:1,h:1,color:'#4c7a57',name:'Plant'}
  ],
  decorMode:false, dragging:null,
  npcs:[], selectedNpc:null, lastNpcDay:-1, performance:{shifts:0,ontime:0},

  // Character defaults (Black woman)
  character:{
    skin:'#2c1f16', hairStyle:'curls', hair:'#0c0b0c',
    top:'#a86dff', bottom:'#22252d', shoes:'#e7ecf2', outfitIndex:0
  }
};

// outfits rotation
const OUTFITS=[
  {top:'#a86dff',bottom:'#22252d',shoes:'#e7ecf2'},
  {top:'#ff6b9a',bottom:'#2a2e39',shoes:'#f5d36b'},
  {top:'#4fd1ff',bottom:'#14202a',shoes:'#c8f7ff'},
  {top:'#7cffb2',bottom:'#1c2a1f',shoes:'#e8ecf1'},
  {top:'#f49b3e',bottom:'#24211a',shoes:'#ffe3b0'},
  {top:'#e84393',bottom:'#1f1b25',shoes:'#ffffff'}
];

// ===== Jobs =====
const JOBS={
  barista:{name:'Barista',open:[6,14],pay:16,reqEdu:0,audition:false},
  stripper:{name:'Performer (Club)',open:[19,2],pay:28,reqEdu:0,audition:true},
  lawyer:{name:'Junior Lawyer',open:[9,19],pay:55,reqEdu:70,audition:false},
  doctor:{name:'Resident Doctor',open:[7,19],pay:60,reqEdu:85,audition:false},
};

// ===== Audio =====
let audioCtx;
function blip(freq=440,dur=0.05,type='sine',gain=0.05){ if(!state.sound) return;
  try{audioCtx=audioCtx||new (window.AudioContext||window.webkitAudioContext)();
    const t=audioCtx.currentTime,o=audioCtx.createOscillator(),g=audioCtx.createGain();
    o.type=type;o.frequency.value=freq;g.gain.value=gain;o.connect(g);g.connect(audioCtx.destination);
    o.start(t);o.stop(t+dur);g.gain.exponentialRampToValueAtTime(0.0001,t+dur);}catch{}}

// ===== Helpers =====
function clamp(n,a,b){return Math.max(a,Math.min(b,n))}
function hour(){return Math.floor((state.t/60)%24)}
function timeFmt(mins){const h=Math.floor((mins/60)%24),m=mins%60,ampm=h>=12?'PM':'AM',hh=((h+11)%12+1);return `${hh}:${m.toString().padStart(2,'0')} ${ampm}`}
function setBars(){
  energyEl.style.width=state.energy+'%';
  hungerEl.style.width=(100-state.hunger)+'%';
  funEl.style.width=state.fun+'%';
  cleanEl.style.width=state.clean+'%';
  eduEl.style.width=state.edu+'%';
  repEl.style.width=state.rep+'%';
  moneyEl.textContent='$'+Math.floor(state.money);
  jobLabel.textContent=state.job?JOBS[state.job].name:'Unemployed';
  clockEl.textContent=timeFmt(state.t);
}
function toastMsg(msg,ms=1200){toast.textContent=msg;toast.hidden=false;clearTimeout(toastMsg._t);toastMsg._t=setTimeout(()=>toast.hidden=true,ms)}

// ===== Loop =====
let last=performance.now();
function loop(now){
  const dt=Math.min(50,now-last); last=now;
  update(dt/1000);
  render();
  requestAnimationFrame(loop);
}
requestAnimationFrame(loop);

function update(dt){
  // minutes progressed this frame
  const minutes = state.speedMinPerSec * dt;
  state.t += minutes;

  // passive needs (scaled softly with time speed)
  const s = state.speedMinPerSec/2;
  state.hunger = clamp(state.hunger + 0.3*s*dt,0,100);
  state.energy = clamp(state.energy - 0.2*s*dt,0,100);
  state.clean  = clamp(state.clean - 0.1*s*dt,0,100);
  state.fun    = clamp(state.fun - 0.08*s*dt,0,100);

  const d = Math.floor(state.t/(24*60));
  if (d!==state.lastNpcDay){ state.lastNpcDay=d; spawnNpcs(); }
  setBars();
}

// ===== NPCs =====
const NAMES=['Alex','Jordan','Taylor','Riley','Casey','Sam','Avery','Kai','Morgan','Skye','Nina','Malik','Jada','Imani','Noah'];
function rand(a){return a[Math.floor(Math.random()*a.length)]}
function spawnNpcs(){
  if(state.npcs.length<3){ for(let i=0;i<3;i++) addNpc(); }
  else { const addCount = 1+Math.floor(Math.random()*2);
    for(let i=0;i<addCount;i++){ if(state.npcs.length>=5){ state.npcs.sort((a,b)=>a.rel-b.rel); state.npcs.shift(); } addNpc(); }
  }
  renderNpcList();
}
function addNpc(){
  const name=rand(NAMES)+' '+(Math.random()<0.5?'B.':'C.');
  state.npcs.push({id:Math.random().toString(36).slice(2),name,rel:Math.floor(Math.random()*20)+5,charm:Math.floor(Math.random()*50)+25,interests:['music','food','fitness','art','tech','travel'].sort(()=>.5-Math.random()).slice(0,2),status:'acquaintance'});
}
const npcList=document.getElementById('npcList'), npcActions=document.getElementById('npcActions'), npcName=document.getElementById('npcName');
function renderNpcList(){
  npcList.innerHTML='';
  state.npcs.forEach(n=>{
    const d=document.createElement('div'); d.className='npc';
    d.innerHTML=`<div><div class="name">${n.name}</div><div class="meta">Interests: ${n.interests.join(', ')}</div></div><div class="rel">${n.rel}</div>`;
    d.addEventListener('click',()=>selectNpc(n.id));
    npcList.appendChild(d);
  });
}
function selectNpc(id){
  state.selectedNpc=state.npcs.find(n=>n.id===id)||null;
  npcActions.hidden=!state.selectedNpc;
  if(state.selectedNpc) npcName.textContent = `${state.selectedNpc.name} ‚Ä¢ ${state.selectedNpc.status} ‚Ä¢ Rel ${state.selectedNpc.rel}`;
}
document.getElementById('panel-relationships').addEventListener('click',e=>{
  const act=e.target.getAttribute('data-npcact'); if(!act) return;
  const n=state.selectedNpc; if(!n){toastMsg('Pick someone first'); return;}
  if(act==='chat'){ state.fun=clamp(state.fun+8,0,100); n.rel=clamp(n.rel+5+Math.floor(Math.random()*6),0,100); timePass(20); toastMsg(`Chatted with ${n.name}`); blip(760,0.05,'sine',0.05); }
  if(act==='compliment'){ const g=Math.random()<0.8?(6+Math.floor(Math.random()*6)):0; n.rel=clamp(n.rel+g,0,100); timePass(10); toastMsg(g?'They smiled':'That landed awkward‚Ä¶'); }
  if(act==='gift'){ if(state.money<25){toastMsg('Need $25');return;} state.money-=25; n.rel=clamp(n.rel+10+Math.floor(Math.random()*10),0,100); timePass(10); toastMsg(`Gave ${n.name} a gift`); blip(640,0.05,'triangle',0.06);}
  if(act==='date'){ if(state.money<40){toastMsg('Need $40');return;} state.money-=40; state.fun=clamp(state.fun+18,0,100); state.clean=clamp(state.clean-6,0,100); state.energy=clamp(state.energy-8,0,100); const b=12+Math.floor(Math.random()*10); n.rel=clamp(n.rel+b,0,100); timePass(120); toastMsg(`Great date (+${b})`); if(n.rel>=70&&n.status!=='partner'){n.status='partner'; toastMsg(`${n.name} is now your partner ‚ù§Ô∏è`,1600); blip(520,0.06,'sine',0.06);} }
  renderNpcList(); selectNpc(n.id); setBars();
});

// ===== Actions =====
const actionsEl=document.getElementById('actions');
const actions={
  eat(){ if(state.money<8){toastMsg('Need $8');return;} state.money-=8; state.hunger=clamp(state.hunger-35,0,100); state.energy=clamp(state.energy+5,0,100); timePass(20); toastMsg('Ate a meal'); blip(520,0.05,'sine',0.06); },
  sleep(){ let mins=0; while(state.energy<95&&mins<8*60){ state.energy=clamp(state.energy+1.2,0,100); state.hunger=clamp(state.hunger+0.4,0,100); mins+=10;} timePass(mins); toastMsg('You slept'); },
  shower(){ state.clean=clamp(state.clean+35,0,100); state.energy=clamp(state.energy+2,0,100); timePass(15); toastMsg('Shower done'); },
  play(){ state.fun=clamp(state.fun+28,0,100); state.energy=clamp(state.energy-6,0,100); timePass(40); toastMsg('Played games'); },
  clean(){ state.clean=clamp(state.clean+28,0,100); state.energy=clamp(state.energy-5,0,100); timePass(30); toastMsg('Tidied up'); },
  study(){ if(state.energy<20){toastMsg('Too tired to study');return;} state.edu=clamp(state.edu+6+Math.floor(Math.random()*4),0,100); state.energy=clamp(state.energy-10,0,100); state.fun=clamp(state.fun-4,0,100); timePass(50); toastMsg('Studied'); },
  work(){
    if(!state.job){toastMsg('No job yet');return;}
    const j=JOBS[state.job], h=hour(), open=j.open[0], close=j.open[1];
    const isOpen = open<close ? (h>=open && h<close) : (h>=open || h<close);
    if(!isOpen){toastMsg('Your job is closed now');return;}
    const hours=2+Math.floor(Math.random()*3), mins=hours*60; let pay=j.pay*hours; if(state.job==='stripper'){pay+=Math.floor(Math.random()*80);}
    const perf=(state.energy>40?1:0.7)*(state.clean>40?1:0.8);
    state.money+=Math.floor(pay*perf);
    state.energy=clamp(state.energy-12*hours/2,0,100); state.hunger=clamp(state.hunger+10*hours/2,0,100); state.fun=clamp(state.fun+(state.job==='stripper'?4:-4),0,100); state.clean=clamp(state.clean-6*hours/2,0,100);
    state.performance.shifts++; if(perf>=1) state.performance.ontime++;
    if(state.performance.ontime>0 && state.performance.ontime%6===0){ j.pay+=2; toastMsg('Nice work ‚Äî raise!'); } else { toastMsg(`Worked ${hours}h, earned $${Math.floor(pay*perf)}`); }
    timePass(mins);
  },
  decorate(){ state.decorMode=!state.decorMode; document.getElementById('shop').hidden=!state.decorMode; toastMsg(state.decorMode?'Decorate mode on':'Decorate off'); }
};
actionsEl.addEventListener('click',e=>{const act=e.target.getAttribute('data-act'); if(!act||!actions[act])return; actions[act](); setBars();});

// Jobs panel apply
document.getElementById('panel-jobs').addEventListener('click',e=>{
  const jDiv=e.target.closest('.job'); if(!jDiv) return;
  const key=jDiv.dataset.job, j=JOBS[key];
  if(key==='stripper'){ const score=(state.fun+state.clean+state.rep)/3+Math.random()*20; if(score<45){toastMsg('Audition didn‚Äôt stick. Try again later.'); return;} state.job=key; toastMsg('You got the gig at the club!'); }
  else { if(state.edu<j.reqEdu){toastMsg('Not qualified yet');return;} state.job=key; toastMsg(`Hired as ${j.name}`); }
  setBars();
});

// ===== Decor drag =====
document.querySelectorAll('.shop-item').forEach(btn=>{
  btn.addEventListener('click',()=>{
    const type=btn.getAttribute('data-item'),
      prices={sofa:80,plant:20,tv:120,bed:150},
      colors={sofa:'#6a5046',plant:'#4c7a57',tv:'#2d2f38',bed:'#46506a'},
      sizes={sofa:[3,2],plant:[1,1],tv:[2,1],bed:[2,3]};
    const price=prices[type]; if(state.money<price){toastMsg('Not enough money');return;}
    state.money-=price; const [w,h]=sizes[type];
    state.items.push({id:type,x:1,y:1,w,h,color:colors[type],name:type[0].toUpperCase()+type.slice(1)});
    toastMsg(`Bought ${type} for $${price}`); blip(600,0.05,'triangle',0.06); setBars();
  });
});
function toCell(px,py){const pad=16,gw=W-pad*2,gh=H-pad*2,cw=gw/state.grid.cols,ch=gh/state.grid.rows; const x=clamp(Math.floor((px-pad)/cw),0,state.grid.cols-1),y=clamp(Math.floor((py-pad)/ch),0,state.grid.rows-1); return {x,y,cw,ch,pad}}
function hitItem(px,py){const {x,y}=toCell(px,py); for(let i=state.items.length-1;i>=0;i--){const it=state.items[i]; if(x>=it.x&&x<it.x+it.w && y>=it.y&&y<it.y+it.h) return {it,i};} return null;}
canvas.addEventListener('pointerdown',e=>{ if(!state.decorMode) return; const r=canvas.getBoundingClientRect(),px=e.clientX-r.left,py=e.clientY-r.top,h=hitItem(px,py); if(h){ const c=toCell(px,py); state.dragging={idx:h.i,off:{dx:c.x-state.items[h.i].x,dy:c.y-state.items[h.i].y}}; }});
canvas.addEventListener('pointermove',e=>{ if(!state.dragging) return; const r=canvas.getBoundingClientRect(),px=e.clientX-r.left,py=e.clientY-r.top,c=toCell(px,py); const it=state.items[state.dragging.idx]; it.x=clamp(c.x-state.dragging.off.dx,0,state.grid.cols-it.w); it.y=clamp(c.y-state.dragging.off.dy,0,state.grid.rows-it.h);});
canvas.addEventListener('pointerup',()=>state.dragging=null);

// ===== Save / Load / Reset / Sound =====
function save(){ const data={v:3,...state,selectedNpc:null,dragging:null}; try{localStorage.setItem('cozysim_char',JSON.stringify(data)); toastMsg('Saved'); blip(800,0.04,'sine',0.05);}catch{toastMsg('Save failed');}}
function load(){ const raw=localStorage.getItem('cozysim_char'); if(!raw){toastMsg('No save');return;} try{ const d=JSON.parse(raw); ['t','speedMinPerSec','energy','hunger','fun','clean','edu','rep','money','job','items','npcs','lastNpcDay','performance','character'].forEach(k=>{ if(d[k]!==undefined) state[k]=d[k]; }); renderNpcList(); setBars(); document.getElementById('timeSlider').value=state.speedMinPerSec; document.getElementById('timeLabel').textContent=state.speedMinPerSec+' min/sec'; toastMsg('Loaded'); blip(520,0.05,'sine',0.05);}catch{toastMsg('Load failed');}}
function reset(){ try{localStorage.removeItem('cozysim_char');}catch{} location.reload();}
document.getElementById('save').addEventListener('click',save);
document.getElementById('load').addEventListener('click',load);
document.getElementById('reset').addEventListener('click',reset);
document.getElementById('mute').addEventListener('click',e=>{ state.sound=!state.sound; e.target.textContent=state.sound?'üîä':'üîá'; });

// ===== Time speed slider =====
const timeSlider=document.getElementById('timeSlider'), timeLabel=document.getElementById('timeLabel');
timeSlider.value=state.speedMinPerSec; timeLabel.textContent=state.speedMinPerSec+' min/sec';
timeSlider.addEventListener('input',()=>{ state.speedMinPerSec=parseFloat(timeSlider.value); timeLabel.textContent=state.speedMinPerSec+' min/sec'; });

// ===== Character Creator / Outfits =====
const creator=document.getElementById('creator'), openCreator=document.getElementById('openCreator'),
closeCreator=document.getElementById('closeCreator'), saveCreator=document.getElementById('saveCreator'),
avatar=document.getElementById('avatar').getContext('2d'), cycleOutfit=document.getElementById('cycleOutfit');

const SKINS=['#2c1f16','#3b2a1d','#5a3b2b','#7a543e','#a1765c'];
const HAIRS=['#0c0b0c','#2b1d12','#4a2c1a','#2b2b2b'];
const TOPS=['#a86dff','#ff6b9a','#4fd1ff','#7cffb2','#f49b3e','#e84393'];
const BOTS=['#22252d','#2a2e39','#14202a','#1c2a1f','#24211a','#1f1b25'];
function buildSwatches(row,colors,selectedKey){ row.innerHTML=''; colors.forEach(c=>{ const s=document.createElement('button'); s.className='swatch'; s.style.background=c; s.addEventListener('click',()=>{ state.character[selectedKey]=c; drawAvatar(); }); row.appendChild(s); }); }
buildSwatches(document.getElementById('skinRow'),SKINS,'skin');
buildSwatches(document.getElementById('hairRow'),HAIRS,'hair');
buildSwatches(document.getElementById('topRow'),TOPS,'top');
buildSwatches(document.getElementById('bottomRow'),BOTS,'bottom');

document.getElementById('hairStyle').value=state.character.hairStyle;
document.getElementById('hairStyle').addEventListener('change',e=>{ state.character.hairStyle=e.target.value; drawAvatar(); });

function drawAvatar(){
  const w=240,h=120; avatar.clearRect(0,0,w,h);
  // body (simple stylized)
  const c=state.character;
  // head
  avatar.fillStyle=c.skin; avatar.beginPath(); avatar.arc(60,55,16,0,Math.PI*2); avatar.fill();
  // hair styles
  avatar.fillStyle=c.hair;
  if(c.hairStyle==='bun'){ avatar.beginPath(); avatar.arc(60,38,10,0,Math.PI*2); avatar.fill(); avatar.beginPath(); avatar.arc(60,55,18,Math.PI,0); avatar.fill();}
  else if(c.hairStyle==='curls'){ for(let i=0;i<8;i++){ avatar.beginPath(); avatar.arc(45+i*4,45+Math.sin(i)*2,6,0,Math.PI*2); avatar.fill(); } }
  else if(c.hairStyle==='braids'){ for(let i=0;i<6;i++){ avatar.fillRect(52+i*3,38+i*1.6,2,18); } }
  else { avatar.fillRect(46,38,28,14); }
  // torso
  avatar.fillStyle=c.top; avatar.fillRect(45,72,30,20);
  // legs
  avatar.fillStyle=c.bottom; avatar.fillRect(48,92,10,20); avatar.fillRect(62,92,10,20);
  // shoes
  avatar.fillStyle=c.shoes; avatar.fillRect(46,112,14,6); avatar.fillRect(60,112,14,6);
  // label
  avatar.fillStyle='#e7ecf2'; avatar.font='12px system-ui'; avatar.fillText('Preview', 150, 20);
}
drawAvatar();

openCreator.addEventListener('click',()=>{ creator.style.display='flex'; drawAvatar(); });
closeCreator.addEventListener('click',()=>creator.style.display='none');
saveCreator.addEventListener('click',()=>{ creator.style.display='none'; toastMsg('Character saved'); save(); });
cycleOutfit.addEventListener('click',()=>{
  state.character.outfitIndex=(state.character.outfitIndex+1)%OUTFITS.length;
  Object.assign(state.character, OUTFITS[state.character.outfitIndex]);
  drawAvatar(); toastMsg('Changed outfit');
});

// ===== Render Room + Character =====
function timePass(mins){ state.t += mins; }
function render(){
  const hr=Math.floor((state.t/60)%24);
  const skyTop=hr>=19||hr<=6?'#070a11':'#0e1217', skyBot=hr>=19||hr<=6?'#0c1018':'#141a21';
  const g=ctx.createLinearGradient(0,0,0,H); g.addColorStop(0,skyTop); g.addColorStop(1,skyBot);
  ctx.fillStyle=g; ctx.fillRect(0,0,W,H);
  const pad=16,gw=W-pad*2,gh=H-pad*2,cw=gw/state.grid.cols,ch=gh/state.grid.rows;
  ctx.save(); ctx.translate(pad,pad);
  ctx.fillStyle='#151b24'; ctx.fillRect(0,0,gw,gh);
  ctx.strokeStyle='rgba(255,255,255,0.05)'; ctx.lineWidth=1;
  for(let c=1;c<state.grid.cols;c++){ ctx.beginPath(); ctx.moveTo(c*cw,0); ctx.lineTo(c*cw,gh); ctx.stroke(); }
  for(let r=1;r<state.grid.rows;r++){ ctx.beginPath(); ctx.moveTo(0,r*ch); ctx.lineTo(gw,r*ch); ctx.stroke(); }
  // furniture
  for(const it of state.items){
    ctx.fillStyle=it.color; ctx.fillRect(it.x*cw,it.y*ch,it.w*cw-2,it.h*ch-2);
    ctx.fillStyle='rgba(255,255,255,0.12)'; ctx.fillRect(it.x*cw,it.y*ch,it.w*cw-2,4);
    ctx.fillStyle='rgba(255,255,255,0.7)'; ctx.font='12px system-ui'; ctx.fillText(it.name,it.x*cw+6,it.y*ch+16);
  }
  // character avatar in room (bottom center)
  const c=state.character, baseX=gw*0.5-10, baseY=gh-24;
  // legs
  ctx.fillStyle=c.bottom; ctx.fillRect(baseX,baseY-20,10,20); ctx.fillRect(baseX+14,baseY-20,10,20);
  // shoes
  ctx.fillStyle=c.shoes; ctx.fillRect(baseX-2,baseY-2,14,6); ctx.fillRect(baseX+12,baseY-2,14,6);
  // torso
  ctx.fillStyle=c.top; ctx.fillRect(baseX-2,baseY-44,28,26);
  // head
  ctx.fillStyle=c.skin; ctx.beginPath(); ctx.arc(baseX+12,baseY-56,8,0,Math.PI*2); ctx.fill();
  // hair on head
  ctx.fillStyle=c.hair;
  if(c.hairStyle==='bun'){ ctx.beginPath(); ctx.arc(baseX+12,baseY-66,6,0,Math.PI*2); ctx.fill(); ctx.fillRect(baseX+2,baseY-64,20,8); }
  else if(c.hairStyle==='curls'){ for(let i=0;i<6;i++){ ctx.beginPath(); ctx.arc(baseX+2+i*4,baseY-66+Math.sin(i)*1.5,4,0,Math.PI*2); ctx.fill(); } }
  else if(c.hairStyle==='braids'){ for(let i=0;i<5;i++){ ctx.fillRect(baseX+6+i*3,baseY-66,2,10); } }
  else { ctx.fillRect(baseX,baseY-66,24,8); }
  ctx.restore();
}

setBars(); spawnNpcs(); renderNpcList();

})();
</script>
</body>
</html>
