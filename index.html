<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no, viewport-fit=cover">
<title>Cozy Sim ‚Äî Move & Relationships</title>
<meta name="theme-color" content="#0f1318">
<style>
*{box-sizing:border-box}html,body{height:100%;margin:0}
body{background:#0f1318;color:#e7ecf2;font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif}
header,footer{position:fixed;left:0;right:0;background:#121821;display:flex;justify-content:space-between;align-items:center;padding:10px 14px;z-index:3}
header{top:0;box-shadow:0 2px 12px rgba(0,0,0,.35)}
footer{bottom:0;gap:8px;justify-content:center;flex-wrap:wrap}
#title{font-weight:700}.pill{font-size:12px;margin-left:6px;background:#1b2430;border-radius:999px;padding:2px 8px;opacity:.85}
.left,.right{display:flex;align-items:center;gap:14px}
main{position:fixed;left:0;right:0;top:54px;bottom:96px;display:flex;flex-direction:column;gap:10px;padding:10px}
#room{flex:1;border-radius:14px;background:#0b0f14;box-shadow:inset 0 0 0 1px rgba(255,255,255,.06), 0 10px 30px rgba(0,0,0,.4)}

#hud{display:grid;grid-template-columns:1fr 1fr;gap:8px}
.bar{display:flex;align-items:center;gap:8px}
.bar label{width:78px;opacity:.85}
.meter{flex:1;height:12px;background:#18202a;border-radius:999px;overflow:hidden}
.meter span{display:block;height:100%;background:linear-gradient(90deg,#4fd1ff,#7cffb2)}

#tabs{display:flex;gap:8px;flex-wrap:wrap}
#tabs button{padding:10px 12px;border:0;border-radius:10px;background:#17202a;color:#e7ecf2}
#tabs button.active{outline:2px solid rgba(255,255,255,.15)}
.panel{display:none}.panel.active{display:block}

.grid-acts{display:grid;grid-template-columns:repeat(4,1fr);gap:8px}
.grid-acts button{padding:12px;border:0;border-radius:12px;background:#17202a;color:#e7ecf2;font-size:15px}
.hint{opacity:.75;font-size:12px;margin-top:6px}

.jobs{display:grid;grid-template-columns:1fr;gap:8px}
.job{display:flex;justify-content:space-between;align-items:center;background:#0e141b;border-radius:10px;padding:10px}
.job .name{font-weight:700}.job .info{opacity:.85;font-size:13px}
.job button{padding:8px 12px;border:0;border-radius:10px;background:#1a2532;color:#e7ecf2}

.npc-list{display:grid;grid-template-columns:1fr;gap:8px}
.npc{display:flex;justify-content:space-between;align-items:center;background:#0e141b;border-radius:10px;padding:10px}
.npc .meta{opacity:.85;font-size:13px}.npc .rel{font-weight:700}
.npc-actions{margin-top:8px;background:#0e141b;border-radius:10px;padding:10px}
.npc-actions .buttons{display:grid;grid-template-columns:repeat(4,1fr);gap:8px}
.npc-actions button{padding:10px;border:0;border-radius:10px;background:#17202a;color:#e7ecf2}

.badge{display:inline-block;background:#1b2430;padding:2px 8px;border-radius:999px;font-size:12px;margin-left:6px;opacity:.9}
.row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
.slider{width:160px}

#toast{position:fixed;left:50%;top:20%;transform:translateX(-50%);background:rgba(0,0,0,.65);padding:10px 14px;border-radius:10px;backdrop-filter:blur(8px);z-index:9}

/* Virtual joystick */
#joy{position:absolute;left:18px;bottom:120px;width:120px;height:120px;border-radius:999px;background:rgba(255,255,255,.06);border:1px solid rgba(255,255,255,.1);touch-action:none;display:none}
#joyKnob{position:absolute;left:50%;top:50%;width:56px;height:56px;border-radius:999px;transform:translate(-50%,-50%);background:rgba(255,255,255,.25)}
/* Interact button */
#interact{position:absolute;right:18px;bottom:120px;padding:12px 16px;border:0;border-radius:12px;background:#1a2532;color:#e7ecf2;display:none}
</style>
</head>
<body>
<header>
  <div class="left">
    <div id="title">Cozy Sim <span class="pill">Plus</span></div>
    <div id="clock">7:00 AM</div>
  </div>
  <div class="right">
    <div id="jobLabel">Unemployed</div>
    <div id="money">$120</div>
  </div>
</header>

<main>
  <div style="position:relative;flex:1">
    <canvas id="room" aria-label="Room view"></canvas>
    <div id="joy"><div id="joyKnob"></div></div>
    <button id="interact">Interact</button>
  </div>

  <section id="hud">
    <div class="bar"><label>Energy</label><div class="meter"><span id="energy"></span></div></div>
    <div class="bar"><label>Hunger</label><div class="meter"><span id="hunger"></span></div></div>
    <div class="bar"><label>Fun</label><div class="meter"><span id="fun"></span></div></div>
    <div class="bar"><label>Clean</label><div class="meter"><span id="clean"></span></div></div>
    <div class="bar"><label>Edu</label><div class="meter"><span id="edu"></span></div></div>
    <div class="bar"><label>Rep</label><div class="meter"><span id="rep"></span></div></div>
  </section>

  <section id="tabs">
    <button data-tab="actions" class="active">Actions</button>
    <button data-tab="jobs">Jobs</button>
    <button data-tab="relationships">Relationships</button>
    <button data-tab="me">Me</button>
  </section>

  <section id="panel-actions" class="panel active">
    <div class="grid-acts" id="actions">
      <button data-act="eat">Eat üç≤</button>
      <button data-act="sleep">Sleep üò¥</button>
      <button data-act="shower">Shower üöø</button>
      <button data-act="play">Watch TV üì∫</button>
      <button data-act="study">Study üìö</button>
      <button data-act="work">Work üíº</button>
      <button data-act="clean">Clean üßπ</button>
      <button data-act="save">Save üíæ</button>
    </div>
    <div class="hint">Tip: use the joystick (bottom left) or tap the floor to **move**. Hit **Interact** when you‚Äôre near a bed, TV, shower, or kitchen.</div>
  </section>

  <section id="panel-jobs" class="panel">
    <div class="jobs">
      <div class="job" data-job="barista"><div class="name">Barista</div><div class="info">Pay $16/hr ‚Ä¢ 6a‚Äì2p ‚Ä¢ No req</div><button>Apply</button></div>
      <div class="job" data-job="stripper"><div class="name">Performer (Club)</div><div class="info">Pay $28/hr + tips ‚Ä¢ 7p‚Äì2a ‚Ä¢ Audition</div><button>Audition</button></div>
      <div class="job" data-job="lawyer"><div class="name">Junior Lawyer</div><div class="info">Pay $55/hr ‚Ä¢ 9a‚Äì7p ‚Ä¢ Edu 70+</div><button>Apply</button></div>
      <div class="job" data-job="doctor"><div class="name">Resident Doctor</div><div class="info">Pay $60/hr ‚Ä¢ 7a‚Äì7p ‚Ä¢ Edu 85+</div><button>Apply</button></div>
    </div>
    <div class="hint">Once hired, work during your job‚Äôs open hours from the Actions tab.</div>
  </section>

  <section id="panel-relationships" class="panel">
    <div id="npcList" class="npc-list"></div>
    <div id="npcActions" class="npc-actions" hidden>
      <div id="npcName">‚Äî</div>
      <div class="buttons">
        <button data-npcact="chat">Chat üí¨</button>
        <button data-npcact="compliment">Compliment üåü</button>
        <button data-npcact="gift">Gift üéÅ ($25)</button>
        <button data-npcact="date">Ask Out ‚ù§Ô∏è ($40)</button>
      </div>
    </div>
    <div class="hint">Build relationships to become partners. NPCs wander the room‚Äîwalk up to them and tap **Interact** to say hi.</div>
  </section>

  <section id="panel-me" class="panel">
    <div class="row">
      <span class="badge">Time speed</span>
      <input id="timeSlider" class="slider" type="range" min="0.5" max="6" step="0.5" value="2">
      <span id="timeLabel" class="badge">2 min/sec</span>
      <span class="badge">Outfit</span>
      <button id="cycleOutfit">Change</button>
    </div>
  </section>
</main>

<div id="toast" hidden></div>

<footer>
  <button id="load">Load</button>
  <button id="reset">Reset</button>
  <button id="mute">üîä</button>
</footer>

<script>
(()=>{
// ===== Layout =====
const canvas=document.getElementById('room'); const ctx=canvas.getContext('2d',{alpha:false});
let W=0,H=0,DPR=Math.max(1,Math.min(2,window.devicePixelRatio||1));
function resize(){W=window.innerWidth-20;H=Math.max(320,window.innerHeight-54-96-260);canvas.width=Math.floor(W*DPR);canvas.height=Math.floor(H*DPR);canvas.style.width=W+'px';canvas.style.height=H+'px';ctx.setTransform(DPR,0,0,DPR,0,0);}
window.addEventListener('resize',resize,{passive:true}); resize();

// ===== UI Els =====
const energyEl=document.getElementById('energy'), hungerEl=document.getElementById('hunger'),
funEl=document.getElementById('fun'), cleanEl=document.getElementById('clean'),
eduEl=document.getElementById('edu'), repEl=document.getElementById('rep'),
moneyEl=document.getElementById('money'), jobLabel=document.getElementById('jobLabel'),
clockEl=document.getElementById('clock'), toast=document.getElementById('toast');
const tabs=document.getElementById('tabs'); const panels={actions:document.getElementById('panel-actions'),jobs:document.getElementById('panel-jobs'),relationships:document.getElementById('panel-relationships'),me:document.getElementById('panel-me')};
tabs.addEventListener('click',e=>{const b=e.target.closest('button');if(!b)return;document.querySelectorAll('#tabs button').forEach(x=>x.classList.remove('active'));b.classList.add('active');Object.values(panels).forEach(p=>p.classList.remove('active'));panels[b.dataset.tab].classList.add('active');});

const joy=document.getElementById('joy'), knob=document.getElementById('joyKnob'), interactBtn=document.getElementById('interact');
const timeSlider=document.getElementById('timeSlider'), timeLabel=document.getElementById('timeLabel');
document.getElementById('cycleOutfit').addEventListener('click',()=>{ avatar.outfit=(avatar.outfit+1)%OUTFITS.length; toastMsg('Outfit changed'); });

// ===== State =====
const state={t:7*60, speedMinPerSec:2, energy:70,hunger:30,fun:40,clean:60,edu:10,rep:10,money:120,sound:true,
  job:null, grid:{cols:12,rows:8},
  items:[ // placed furniture + kitchen/shower markers
    {id:'bed',name:'Bed',x:2,y:3,w:2,h:3,color:'#3d4660'},
    {id:'sofa',name:'Sofa',x:6,y:3,w:3,h:2,color:'#8a685a'},
    {id:'tv',name:'TV',x:4,y:6,w:2,h:1,color:'#2d2f38'},
    {id:'plant',name:'Plant',x:10,y:2,w:1,h:1,color:'#4c7a57'},
    {id:'shower',name:'Shower',x:0,y:1,w:1,h:2,color:'#366'},
    {id:'kitchen',name:'Kitchen',x:0,y:5,w:2,h:2,color:'#444'}
  ],
  npcs:[], selectedNpc:null,lastNpcDay:-1,performance:{shifts:0,ontime:0}
};

const avatar={x:W/2,y:H*0.7,spd:100,outfit:0,skin:'#2c1f16',hair:'#0c0b0c',hairStyle:'curls'};
const OUTFITS=[{top:'#a86dff',bottom:'#22252d',shoes:'#e7ecf2'},{top:'#ff6b9a',bottom:'#2a2e39',shoes:'#f5d36b'},{top:'#4fd1ff',bottom:'#14202a',shoes:'#c8f7ff'},{top:'#7cffb2',bottom:'#1c2a1f',shoes:'#e8ecf1'}];

// ===== Jobs =====
const JOBS={barista:{name:'Barista',open:[6,14],pay:16,reqEdu:0}, stripper:{name:'Performer (Club)',open:[19,2],pay:28,reqEdu:0,audition:true}, lawyer:{name:'Junior Lawyer',open:[9,19],pay:55,reqEdu:70}, doctor:{name:'Resident Doctor',open:[7,19],pay:60,reqEdu:85}};

// ===== Audio =====
let audioCtx; function blip(f=440,d=0.05,t='sine',g=0.05){if(!state.sound)return;try{audioCtx=audioCtx||new (window.AudioContext||window.webkitAudioContext)();const T=audioCtx.currentTime,o=audioCtx.createOscillator(),G=audioCtx.createGain();o.type=t;o.frequency.value=f;G.gain.value=g;o.connect(G);G.connect(audioCtx.destination);o.start(T);o.stop(T+d);G.gain.exponentialRampToValueAtTime(0.0001,T+d);}catch{}}

// ===== Helpers =====
function clamp(n,a,b){return Math.max(a,Math.min(b,n))}
function hour(){return Math.floor((state.t/60)%24)}
function timeFmt(mins){const h=Math.floor((mins/60)%24),m=mins%60,ampm=h>=12?'PM':'AM',hh=((h+11)%12+1);return `${hh}:${m.toString().padStart(2,'0')} ${ampm}`}
function toastMsg(m,ms=1200){toast.textContent=m;toast.hidden=false;clearTimeout(toastMsg._t);toastMsg._t=setTimeout(()=>toast.hidden=true,ms)}
function setBars(){energyEl.style.width=state.energy+'%';hungerEl.style.width=(100-state.hunger)+'%';funEl.style.width=state.fun+'%';cleanEl.style.width=state.clean+'%';eduEl.style.width=state.edu+'%';repEl.style.width=state.rep+'%';moneyEl.textContent='$'+Math.floor(state.money);jobLabel.textContent=state.job?JOBS[state.job].name:'Unemployed';clockEl.textContent=timeFmt(state.t);}

// ===== Movement (tap-to-move + joystick) =====
let target=null, joyActive=false, joyStart=null, joyVec={x:0,y:0};
canvas.addEventListener('pointerdown',e=>{ // tap-to-move
  const r=canvas.getBoundingClientRect(); const x=e.clientX-r.left, y=e.clientY-r.top;
  target={x,y};
});
function startJoy(){joy.style.display='block';joyActive=true;joyStart=null;}
function stopJoy(){joy.style.display='none';joyActive=false;joyVec.x=joyVec.y=0;knob.style.left='50%';knob.style.top='50%';}
canvas.addEventListener('pointerdown',()=>startJoy());
canvas.addEventListener('pointerup',()=>stopJoy());
canvas.addEventListener('pointermove',e=>{
  if(!joyActive) return;
  const r=joy.getBoundingClientRect(); if(!joyStart){joyStart={x:r.left+r.width/2,y:r.top+r.height/2};}
  const dx=e.clientX-joyStart.x, dy=e.clientY-joyStart.y; const len=Math.hypot(dx,dy); const max=40; const kx=dx/Math.max(1,len), ky=dy/Math.max(1,len);
  joyVec.x=kx; joyVec.y=ky;
  const px=clamp(dx,-max,max), py=clamp(dy,-max,max);
  knob.style.left=(50+px/1.2)+'%'; knob.style.top=(50+py/1.2)+'%';
});

// ===== Interactions =====
const INTERACTS=[
  {id:'bed', act:()=>actions.sleep(), tip:'Sleep'},
  {id:'tv', act:()=>actions.play(), tip:'Watch TV'},
  {id:'shower', act:()=>actions.shower(), tip:'Shower'},
  {id:'kitchen', act:()=>actions.eat(), tip:'Eat'},
];
function nearThing(){
  const g=geom(); const px=avatar.x, py=avatar.y, pr=18;
  for(const it of state.items){
    const r=rectFor(it,g); // hitbox
    const nx=clamp(px,r.x, r.x+r.w), ny=clamp(py,r.y, r.y+r.h);
    const dist=Math.hypot(px-nx, py-ny);
    if(dist<pr) return it;
  }
  // check NPCs
  for(const n of state.npcs){
    const dist=Math.hypot(px-n.x, py-n.y);
    if(dist<24) return n;
  }
  return null;
}
interactBtn.addEventListener('click',()=>{
  const n=nearThing(); if(!n) return;
  if(n.isNpc){ // greet
    openRelationships(n);
    toastMsg('You say hi üëã'); blip(760,0.05,'sine',0.05);
  }else{
    const handler=INTERACTS.find(x=>x.id===n.id);
    if(handler){ handler.act(); }
  }
});

// ===== Actions =====
const actions={
  eat(){ if(state.money<8){toastMsg('Need $8');return;} state.money-=8; state.hunger=clamp(state.hunger-35,0,100); state.energy=clamp(state.energy+5,0,100); timePass(20); toastMsg('Ate a meal'); blip(520,0.05,'sine',0.06); },
  sleep(){ let mins=0; while(state.energy<95&&mins<8*60){ state.energy=clamp(state.energy+1.2,0,100); state.hunger=clamp(state.hunger+0.4,0,100); mins+=10;} timePass(mins); toastMsg('You slept'); },
  shower(){ state.clean=clamp(state.clean+35,0,100); state.energy=clamp(state.energy+2,0,100); timePass(15); toastMsg('Shower done'); },
  play(){ state.fun=clamp(state.fun+28,0,100); state.energy=clamp(state.energy-6,0,100); timePass(40); toastMsg('Watched TV'); },
  study(){ if(state.energy<20){toastMsg('Too tired to study');return;} state.edu=clamp(state.edu+6+Math.floor(Math.random()*4),0,100); state.energy=clamp(state.energy-10,0,100); state.fun=clamp(state.fun-4,0,100); timePass(50); toastMsg('Studied'); },
  work(){
    if(!state.job){toastMsg('No job yet');return;}
    const j=JOBS[state.job], h=hour(), open=j.open[0], close=j.open[1];
    const isOpen = open<close ? (h>=open && h<close) : (h>=open || h<close);
    if(!isOpen){toastMsg('Your job is closed now');return;}
    const hours=2+Math.floor(Math.random()*3), mins=hours*60; let pay=j.pay*hours; if(state.job==='stripper'){pay+=Math.floor(Math.random()*80);}
    const perf=(state.energy>40?1:0.7)*(state.clean>40?1:0.8);
    state.money+=Math.floor(pay*perf);
    state.energy=clamp(state.energy-12*hours/2,0,100); state.hunger=clamp(state.hunger+10*hours/2,0,100); state.fun=clamp(state.fun+(state.job==='stripper'?4:-4),0,100); state.clean=clamp(state.clean-6*hours/2,0,100);
    state.performance.shifts++; if(perf>=1) state.performance.ontime++;
    if(state.performance.ontime>0 && state.performance.ontime%6===0){ j.pay+=2; toastMsg('Raise!'); } else { toastMsg(`Worked ${hours}h, earned $${Math.floor(pay*perf)}`); }
    timePass(mins);
  },
  clean(){ state.clean=clamp(state.clean+28,0,100); state.energy=clamp(state.energy-5,0,100); timePass(30); toastMsg('Tidied up'); },
  save(){ save(); toastMsg('Saved'); }
};
document.getElementById('actions').addEventListener('click',e=>{
  const act=e.target.getAttribute('data-act'); if(!act||!actions[act])return; actions[act](); setBars();
});

// Jobs apply
document.getElementById('panel-jobs').addEventListener('click',e=>{
  const jDiv=e.target.closest('.job'); if(!jDiv) return;
  const key=jDiv.dataset.job, j=JOBS[key];
  if(key==='stripper'){ const score=(state.fun+state.clean+state.rep)/3+Math.random()*20; if(score<45){toastMsg('Audition didn‚Äôt stick. Try again.'); return;} state.job=key; }
  else { if(state.edu<j.reqEdu){toastMsg('Not qualified yet');return;} state.job=key; }
  jobLabel.textContent=JOBS[state.job].name; toastMsg('Hired!');
});

// ===== NPCs =====
const npcList=document.getElementById('npcList'), npcActions=document.getElementById('npcActions'), npcName=document.getElementById('npcName');
function addNpc(){ // spawn at window area
  const n={id:Math.random().toString(36).slice(2),name:rand(['Alex','Jordan','Taylor','Riley','Casey','Avery','Kai','Skye','Nina','Malik','Jada','Imani','Noah'])+' '+(Math.random()<0.5?'B.':'C.'),rel:10+Math.floor(Math.random()*15),x:W-120,y:120,vx:(Math.random()<.5?-1:1)*20,isNpc:true,status:'acquaintance'};
  state.npcs.push(n);
}
function rand(a){return a[Math.floor(Math.random()*a.length)]}
function moveNpcs(dt){
  for(const n of state.npcs){
    n.x+=n.vx*dt; if(n.x<80||n.x>W-80) n.vx*=-1;
  }
}
function renderNpcList(){
  npcList.innerHTML='';
  state.npcs.forEach(n=>{const d=document.createElement('div');d.className='npc';d.innerHTML=`<div><div class="name">${n.name}</div><div class="meta">Status: ${n.status}</div></div><div class="rel">${n.rel}</div>`;d.addEventListener('click',()=>selectNpc(n.id));npcList.appendChild(d);});
}
function selectNpc(id){state.selectedNpc=state.npcs.find(n=>n.id===id)||null; npcActions.hidden=!state.selectedNpc; if(state.selectedNpc) npcName.textContent=`${state.selectedNpc.name} ‚Ä¢ Rel ${state.selectedNpc.rel}`;}

document.getElementById('panel-relationships').addEventListener('click',e=>{
  const act=e.target.getAttribute('data-npcact'); if(!act) return;
  const n=state.selectedNpc; if(!n){toastMsg('Pick someone first');return;}
  if(act==='chat'){ state.fun=clamp(state.fun+8,0,100); n.rel=clamp(n.rel+5+Math.floor(Math.random()*6),0,100); timePass(20); toastMsg(`Chatted with ${n.name}`); blip(760,0.05,'sine',0.05);}
  if(act==='compliment'){ const g=Math.random()<0.8?(6+Math.floor(Math.random()*6)):0; n.rel=clamp(n.rel+g,0,100); timePass(10); toastMsg(g?'They smiled':'Awkward‚Ä¶');}
  if(act==='gift'){ if(state.money<25){toastMsg('Need $25');return;} state.money-=25; n.rel=clamp(n.rel+10+Math.floor(Math.random()*10),0,100); timePass(10); toastMsg('They loved it!');}
  if(act==='date'){ if(state.money<40){toastMsg('Need $40');return;} state.money-=40; state.fun=clamp(state.fun+18,0,100); state.clean=clamp(state.clean-6,0,100); state.energy=clamp(state.energy-8,0,100); const b=12+Math.floor(Math.random()*10); n.rel=clamp(n.rel+b,0,100); timePass(120); if(n.rel>=70&&n.status!=='partner'){n.status='partner'; toastMsg(`${n.name} is now your partner ‚ù§Ô∏è`,1600);} else {toastMsg('Great date!');}}
  renderNpcList(); setBars();
});
function openRelationships(n){ // select clicked NPC
  state.selectedNpc=n; renderNpcList(); selectNpc(n.id);
}

// ===== Save/Load =====
function save(){const data={v:4,...state,avatar};localStorage.setItem('cozysim_move',JSON.stringify(data));}
function load(){const raw=localStorage.getItem('cozysim_move'); if(!raw){toastMsg('No save');return;} try{const d=JSON.parse(raw); Object.assign(state,d); Object.assign(avatar,d.avatar||avatar); renderNpcList(); setBars(); toastMsg('Loaded');}catch{toastMsg('Load failed');}}
function reset(){localStorage.removeItem('cozysim_move'); location.reload();}
document.getElementById('load').addEventListener('click',load);
document.getElementById('reset').addEventListener('click',reset);
document.getElementById('mute').addEventListener('click',e=>{state.sound=!state.sound; e.target.textContent=state.sound?'üîä':'üîá';});

// ===== Time slider =====
timeSlider.addEventListener('input',()=>{ state.speedMinPerSec=parseFloat(timeSlider.value); timeLabel.textContent=state.speedMinPerSec+' min/sec'; });

// ===== Core Loop =====
let last=performance.now();
function loop(now){
  const dt=Math.min(50,now-last)/1000; last=now;
  update(dt);
  render();
  requestAnimationFrame(loop);
}
requestAnimationFrame(loop);

function update(dt){
  state.t += state.speedMinPerSec * dt;
  // needs decay (gentler)
  const s=state.speedMinPerSec/2;
  state.hunger=clamp(state.hunger+0.25*s*dt,0,100);
  state.energy=clamp(state.energy-0.18*s*dt,0,100);
  state.clean =clamp(state.clean -0.10*s*dt,0,100);
  state.fun   =clamp(state.fun   -0.08*s*dt,0,100);

  // NPC spawn daily
  const d=Math.floor(state.t/(24*60));
  if(d!==state.lastNpcDay){ state.lastNpcDay=d; if(state.npcs.length<4) addNpc(); }

  // movement
  const speed=avatar.spd; let vx=0,vy=0;
  if(joyActive){ vx=joyVec.x*speed; vy=joyVec.y*speed; target=null; }
  if(target){ const dx=target.x-avatar.x, dy=target.y-avatar.y, L=Math.hypot(dx,dy); if(L>2){ vx=dx/L*speed; vy=dy/L*speed; } else target=null; }
  avatar.x=clamp(avatar.x+vx*dt, 24, W-24); avatar.y=clamp(avatar.y+vy*dt, 100, H-24);

  // show interact when near something
  const n=nearThing();
  if(n){ interactBtn.style.display='block'; interactBtn.textContent = n.isNpc? 'Talk' : (INTERACTS.find(x=>x.id===n.id)?.tip || 'Interact'); }
  else interactBtn.style.display='none';

  setBars();
}

function geom(){const pad=16,gw=W-pad*2,gh=H-pad*2; return {pad,gw,gh,cw:gw/state.grid.cols,ch:gh/state.grid.rows};}
function rectFor(it,g){ const {pad,cw,ch}=g; return {x:pad+it.x*cw, y:pad+it.y*ch, w:it.w*cw-2, h:it.h*ch-2}; }

// ===== Render (apartment look) =====
function render(){
  const hr=Math.floor((state.t/60)%24);
  const wallTop='#111722', wallBot='#0d141b';
  const grad=ctx.createLinearGradient(0,0,0,H*0.6); grad.addColorStop(0,wallTop); grad.addColorStop(1,wallBot);
  ctx.fillStyle=grad; ctx.fillRect(0,0,W,H);

  const {pad,gw,gh,cw,ch}=geom();
  ctx.save(); ctx.translate(pad,pad);

  // floorboards
  const floorY=gh*0.65, plankH=16;
  ctx.fillStyle='#0f151c'; ctx.fillRect(0,0,gw,gh);
  ctx.fillStyle='#0a0f14'; ctx.fillRect(0,floorY-6,gw,6);
  for(let y=floorY;y<gh;y+=plankH){ ctx.fillStyle=(Math.floor(y/plankH)%2===0)?'#1a2026':'#181e24'; ctx.fillRect(0,y,gw,plankH); ctx.strokeStyle='rgba(0,0,0,.15)'; ctx.beginPath(); ctx.moveTo(0,y); ctx.lineTo(gw,y); ctx.stroke(); }

  // window
  ctx.fillStyle='#0b0f14'; ctx.fillRect(gw-160,28,120,80);
  ctx.fillStyle=hr>=19||hr<=6?'#0a1420':'#a3d7ff'; ctx.fillRect(gw-152,36,104,64);
  ctx.fillStyle='rgba(255,255,255,.8)'; ctx.fillRect(gw-104,36,2,64); ctx.fillRect(gw-152,66,104,2);

  // rug
  ctx.fillStyle='#23283a'; ctx.beginPath(); roundRect(ctx,gw*0.35,floorY+18,160,90,14); ctx.fill();

  // furniture + shadows
  function shadow(x,y,w,h,a=.25){ctx.fillStyle=`rgba(0,0,0,${a})`; ctx.filter='blur(6px)'; ctx.fillRect(x+6,y+h-4,w,8); ctx.filter='none';}
  for(const it of state.items){
    const x=it.x*cw, y=it.y*ch, w=it.w*cw-2, h=it.h*ch-2; shadow(x,y,w,h);
    if(it.id==='bed'){ ctx.fillStyle='#3d4660'; ctx.fillRect(x,y,w,h); ctx.fillStyle='#7a89c2'; ctx.fillRect(x+6,y+h*0.45,w-12,h*0.5); ctx.fillStyle='#dfe6f2'; ctx.fillRect(x+8,y+8,w*0.45,h*0.22); }
    else if(it.id==='sofa'){ ctx.fillStyle='#8a685a'; ctx.fillRect(x,y+h*0.25,w,h*0.75); ctx.fillStyle='#9b7464'; ctx.fillRect(x,y,w,h*0.35); ctx.fillStyle='#b58a7a'; ctx.fillRect(x+w*0.1,y+h*0.35,w*0.35,h*0.35); ctx.fillRect(x+w*0.55,y+h*0.35,w*0.35,h*0.35); }
    else if(it.id==='tv'){ ctx.fillStyle='#1d2129'; ctx.fillRect(x,y,w,h); ctx.fillStyle='#2a2f3a'; ctx.fillRect(x+4,y+3,w-8,h-6); ctx.fillStyle='#2c313c'; ctx.fillRect(x+w*0.4,y+h-4,w*0.2,4); }
    else if(it.id==='shower'){ ctx.fillStyle='#2a3a44'; ctx.fillRect(x,y,w,h); }
    else if(it.id==='kitchen'){ ctx.fillStyle='#3a3a3a'; ctx.fillRect(x,y,w,h); }
    else if(it.id==='plant'){ ctx.fillStyle='#5c3b2a'; ctx.fillRect(x+2,y+h*0.45,w-4,h*0.55); ctx.fillStyle='#4caf6d'; ctx.beginPath(); ctx.ellipse(x+w*0.5,y+h*0.3,w*0.8,h*0.6,0,0,Math.PI*2); ctx.fill(); }
  }

  // player
  drawAvatar(ctx, avatar, gw*0.52, gh*0.82);

  // NPCs (as simple avatars)
  for(const n of state.npcs){
    const a={x:n.x-pad,y:n.y-pad,skin:'#c99b75',hair:'#2b2b2b',hairStyle:'short',outfit:0};
    drawAvatar(ctx, a, 0, 0, true);
  }

  ctx.restore();
}

function drawAvatar(ctx,a,baseX,baseY,absolute=false){
  const o=OUTFITS[a.outfit||0];
  const x=absolute? a.x : baseX-10, y=absolute? a.y : baseY;
  // legs
  ctx.fillStyle=o.bottom; ctx.fillRect(x,y-20,10,20); ctx.fillRect(x+14,y-20,10,20);
  // shoes
  ctx.fillStyle=o.shoes; ctx.fillRect(x-2,y-2,14,6); ctx.fillRect(x+12,y-2,14,6);
  // torso
  ctx.fillStyle=o.top; ctx.fillRect(x-2,y-44,28,26);
  // head
  ctx.fillStyle=a.skin||'#2c1f16'; ctx.beginPath(); ctx.arc(x+12,y-56,8,0,Math.PI*2); ctx.fill();
  // hair
  ctx.fillStyle=a.hair||'#0c0b0c';
  if(a.hairStyle==='bun'){ ctx.beginPath(); ctx.arc(x+12,y-66,6,0,Math.PI*2); ctx.fill(); ctx.fillRect(x,y-64,24,8); }
  else if(a.hairStyle==='curls'){ for(let i=0;i<6;i++){ ctx.beginPath(); ctx.arc(x+i*4,y-66+Math.sin(i)*1.5,4,0,Math.PI*2); ctx.fill(); } }
  else if(a.hairStyle==='braids'){ for(let i=0;i<5;i++){ ctx.fillRect(x+6+i*3,y-66,2,10); } }
  else { ctx.fillRect(x,y-66,24,8); }
}

function roundRect(c,x,y,w,h,r){c.moveTo(x+r,y);c.lineTo(x+w-r,y);c.quadraticCurveTo(x+w,y,x+w,y+r);c.lineTo(x+w,y+h-r);c.quadraticCurveTo(x+w,y+h,x+w-r,y+h);c.lineTo(x+r,y+h);c.quadraticCurveTo(x,y+h,x,y+h-r);c.lineTo(x,y+r);c.quadraticCurveTo(x,y,x+r,y);}

// ===== Daily spawn first NPC =====
addNpc(); renderNpcList();

// ===== Utils =====
function timePass(mins){ state.t += mins; }

// ===== Loop helpers =====
setBars();

})();
</script>
</body>
</html>
